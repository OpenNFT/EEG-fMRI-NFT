# EEG-fMRI Analysis Pipeline

This pipeline processes EEG and fMRI data to train regressors, perform clustering analysis, and generate visualizations. The pipeline consists of 6 main scripts that should be run in sequence.

## Directory Structure

Ensure your data is organized as follows:

```
/your_project_directory/
├── eeg_data/                    # Raw EEG .set files
│   ├── sub-XXX_ses-dayX_*.set
│   └── ...
├── mri/                         # All MRI data
│   ├── sub-XXX_ses-dayX_*_bold*.nii.gz    # fMRI files
│   ├── ROI/                     # ROI subfolder (required)
│   │   ├── sub-XXX_ses-dayX_roi.nii.gz    # ROI files
│   │   └── ...
│   └── ...
├── eeg_windows/                 # Generated by eeg_loader.py
├── trained_regressors/          # Generated by train_for_all.py
├── topomaps/                    # Generated by topomaps.py
├── clustering_results/          # Generated by clustering.py
├── clustering_training_output/  # Generated by train_clustering.py
└── bands.json                   # Generated by psd.py
```

**Important:** The ROI files must be placed in a separate `ROI/` subfolder within the `mri/` directory.

## Prerequisites

- Python with required packages: `mne`, `numpy`, `scipy`, `sklearn`, `matplotlib`, `nibabel`, `pandas`, `stockwell`
- EEG data in EEGLAB `.set` format
- fMRI data in NIfTI `.nii.gz` format
- ROI masks in NIfTI format

## Pipeline Steps

### 1. Frequency Band Analysis (`psd.py`)

**Purpose:** Analyzes EEG data to determine optimal frequency bands for each channel.

```bash
python psd.py "/path/to/eeg_data" "/path/to/bands.json" --N 10 --fmax 60.0
```

**Parameters:**
- `eeg_data_directory`: Directory containing raw EEG `.set` files
- `output_json`: Path where frequency band parameters will be saved
- `--N 10`: Number of frequency bands to create (default: 10)
- `--fmax 60.0`: Maximum frequency to analyze (default: 60.0 Hz)

**Output:** `bands.json` - Contains frequency bands and normalization parameters for each channel

---

### 2. EEG Preprocessing (`eeg_loader.py`)

**Purpose:** Preprocesses EEG data using the frequency bands from step 1, extracts time windows synchronized with fMRI.

```bash
python eeg_loader.py "/path/to/eeg_data" "/path/to/bands.json" "/path/to/eeg_windows"
```

**Parameters:**
- `directory`: Directory containing raw EEG `.set` files
- `json_path`: Path to the frequency bands JSON file from step 1
- `output_base_dir`: Directory where preprocessed EEG windows will be saved

**Output:** 
- `eeg_windows/sub-XXX_ses-dayX/eeg_preprocessed.npy` - Preprocessed EEG features
- `eeg_windows/sub-XXX_ses-dayX/metadata.json` - Session metadata

---

### 3. Regressor Training (`train_for_all.py`)

**Purpose:** Trains regression models to predict fMRI signals from EEG features for all subjects and channels.

```bash
python train_for_all.py "/path/to/eeg_windows" "/path/to/mri" "/path/to/mri/ROI" "/path/to/trained_regressors"
```

**Parameters:**
- `eeg_base`: Directory containing preprocessed EEG data from step 2
- `fmri_base`: Directory containing fMRI `.nii.gz` files
- `roi_base`: Directory containing ROI `.nii.gz` files (ROI subfolder within mri directory)
- `output_dir`: Directory where trained models and results will be saved

**Output:**
- `trained_regressors/all_subjects_results.csv` - Performance metrics for all subjects/channels
- `trained_regressors/sub-XXX_ses-dayX/` - Individual subject models and results

---

### 4. Topographic Maps (`topomaps.py`)

**Purpose:** Generates topographic maps showing EEG-fMRI correlation strength across the scalp.

```bash
python topomaps.py "/path/to/eeg_windows" "/path/to/trained_regressors/all_subjects_results.csv" "/path/to/topomaps" 0.3
```

**Parameters:**
- `eeg_base`: Directory containing preprocessed EEG data
- `results_csv`: CSV file with regression results from step 3
- `output_dir`: Directory where topographic maps will be saved
- `threshold`: Minimum correlation threshold for visualization (e.g., 0.3)

**Output:**
- `topomaps/*.png` - Topographic maps for different metrics and subjects

---

### 5. Clustering Analysis (`clustering.py`)

**Purpose:** Performs clustering analysis to identify groups of subjects with similar EEG-fMRI relationships.

```bash
python clustering.py "/path/to/trained_regressors/all_subjects_results.csv" "/path/to/clustering_results" --channel F8
```

**Parameters:**
- `results_csv`: CSV file with regression results from step 3
- `output_dir`: Directory where clustering results will be saved
- `--channel F8`: Specific EEG channel to use for clustering (optional)

**Output:**
- `clustering_results/*.csv` - Cluster assignments and metrics
- `clustering_results/*.png` - Clustering visualizations

---

### 6. Cluster-Based Training (`train_clustering.py`)

**Purpose:** Selects representative subjects from clustering and performs leave-one-out cross-validation training.

```bash
python train_clustering.py "/path/to/eeg_windows" "/path/to/mri" "/path/to/mri/ROI" "/path/to/trained_regressors/all_subjects_results.csv" "/path/to/clustering_training_output" "F8"
```

**Parameters:**
- `eeg_base`: Directory containing preprocessed EEG data
- `fmri_base`: Directory containing fMRI files
- `roi_base`: Directory containing ROI files (ROI subfolder within mri directory)
- `results_csv`: CSV file with regression results from step 3
- `output_dir`: Directory where cluster training results will be saved
- `clustering_channel`: EEG channel to use for clustering and training (e.g., "F8")

**Output:**
- `clustering_training_output/leave_one_out_results_F8.csv` - Cross-validation results
- `clustering_training_output/cluster_models_F8.pkl` - Trained models
- `clustering_training_output/sub-XXX_ses-dayX/` - Individual subject models

---

## Complete Pipeline Execution

To run the entire pipeline from start to finish:

```bash
# Step 1: Analyze frequency bands
python psd.py "/path/to/eeg_data" "/path/to/bands.json" --N 10 --fmax 60.0

# Step 2: Preprocess EEG data
python eeg_loader.py "/path/to/eeg_data" "/path/to/bands.json" "/path/to/eeg_windows"

# Step 3: Train regressors for all subjects
python train_for_all.py "/path/to/eeg_windows" "/path/to/mri" "/path/to/mri/ROI" "/path/to/trained_regressors"

# Step 4: Generate topographic maps
python topomaps.py "/path/to/eeg_windows" "/path/to/trained_regressors/all_subjects_results.csv" "/path/to/topomaps" 0.3

# Step 5: Perform clustering analysis
python clustering.py "/path/to/trained_regressors/all_subjects_results.csv" "/path/to/clustering_results" --channel F8

# Step 6: Train models on clustered subjects
python train_clustering.py "/path/to/eeg_windows" "/path/to/mri" "/path/to/mri/ROI" "/path/to/trained_regressors/all_subjects_results.csv" "/path/to/clustering_training_output" "F8"
```
