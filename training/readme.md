# EEG-fMRI Analysis Pipeline

This pipeline processes EEG and fMRI data to train regressors, perform clustering analysis, and generate visualizations. The pipeline can be run using individual scripts or through the main entry point.

## Directory Structure

Ensure your data is organized as follows:

```
/your_project_directory/
├── eeg_data/                    # Raw EEG .set files or preprocessed .npy files
│   ├── sub-XXX_ses-dayX/
│   │   ├── sub-XXX_ses-dayX_eeg_preprocessed.npy
│   │   └── sub-XXX_ses-dayX_metadata.json
│   └── ...
├── mri/                         # All MRI data
│   ├── sub-XXX_ses-dayX_*_bold*.nii.gz    # fMRI files
│   └── ...
├── roi/                         # ROI files (separate directory)
│   ├── sub-XXX_ses-dayX_roi.nii.gz
│   └── ...
├── output/                      # Generated by main.py
│   ├── sub-XXX_ses-dayX/
│   │   ├── sub-XXX_ses-dayX_results.csv
│   │   ├── sub-XXX_ses-dayX_models.joblib
│   │   └── sub-XXX_ses-dayX_enhanced_metadata.joblib
│   └── ...
├── topomaps/                    # Generated by topomaps.py
├── clustering_results/          # Generated by clustering.py
├── clustering_training_output/  # Generated by train_clustering.py
└── bands.json                   # Generated by psd.py (if using full pipeline)
```

## Prerequisites

Install required Python packages:

```bash
pip install numpy scipy scikit-learn nibabel pandas mne matplotlib stockwell joblib tqdm
```

**Required data formats:**
- EEG data: Preprocessed `.npy` files with corresponding metadata JSON files
- fMRI data: NIfTI `.nii.gz` format
- ROI masks: NIfTI `.nii.gz` format

## Full Pipeline Steps (Individual Scripts)

If you need to run the complete preprocessing pipeline from raw EEG data:

### 1. Frequency Band Analysis (`psd.py`)

Analyzes raw EEG data to determine optimal frequency bands:

```bash
python psd.py "/path/to/raw_eeg_data" "/path/to/bands.json" --N 10 --fmax 60.0
```

### 2. EEG Preprocessing (`eeg_loader.py`)

Preprocesses raw EEG data using frequency bands:

```bash
python eeg_loader.py "/path/to/raw_eeg_data" "/path/to/bands.json" "/path/to/eeg_windows"
```

### 3. Regressor Training (`train_for_all.py`)

Train regression models for all subjects and channels:

```bash
python train_for_all.py "/path/to/eeg_windows" "/path/to/mri" "/path/to/roi" "/path/to/trained_regressors"
```

### 4. Topographic Maps (`topomaps.py`)

Generate scalp topography visualizations:

```bash
python topomaps.py "/path/to/eeg_windows" "/path/to/output/all_subjects_results.csv" "/path/to/topomaps" 0.3
```

### 5. Clustering Analysis (`clustering.py`)

Identify subject groups with similar EEG-fMRI relationships:

```bash
python clustering.py "/path/to/output/all_subjects_results.csv" "/path/to/clustering_results" --channel F8
```

### 6. Cluster-Based Training (`train_clustering.py`)

Train models on clustered subjects with cross-validation:

```bash
python train_clustering.py "/path/to/eeg_windows" "/path/to/mri" "/path/to/roi" "/path/to/output/all_subjects_results.csv" "/path/to/clustering_training_output" "F8"
```

## Output Files

### Main Pipeline Output

For each subject, the pipeline generates:

- `sub-XXX_ses-dayX_results.csv`: Performance metrics (Pearson r, MSE, R²) for each EEG channel
- `sub-XXX_ses-dayX_models.joblib`: Trained Ridge regression models for each channel
- `sub-XXX_ses-dayX_enhanced_metadata.joblib`: Enhanced metadata including channel information

### Results CSV Format

The results CSV contains the following columns:
- `channel_name`: EEG channel name
- `pearson r test`: Correlation between predicted and actual fMRI signals
- `MSE test`: Mean squared error
- `r2 test`: R-squared score
- `subject_id`, `sub_id`, `ses_id`, `run_id`: Subject identification fields

## Usage Examples

### Complete Pipeline from Raw Data

```bash
# 1. Analyze frequency bands
python psd.py "./raw_eeg" "./bands.json"

# 2. Preprocess EEG 
python eeg_loader.py "./raw_eeg" "./bands.json" "./eeg_data"

# 3. Train models
python train_for_all.py "./eeg_data" "./mri" "./roi" "./trained_regressors"

# 4. Generate visualizations
python topomaps.py "./eeg_data" "./results/all_subjects_results.csv" "./topomaps" 0.3

# 5. Clustering analysis
python clustering.py "./results/all_subjects_results.csv" "./clustering" --channel F8
```
